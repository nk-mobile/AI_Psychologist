<!-- chat/templates/chat/chat_history.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>История чатов</title>
    <!-- Исправлены лишние пробелы -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {height: 100vh; overflow: hidden;}
        .sidebar {height: 100%; overflow-y: auto; border-right: 1px solid #ccc;}
        .chat-window {height: 100%; overflow-y: auto; display: flex; flex-direction: column;}
        .chat-messages {flex-grow: 1; overflow-y: auto; padding: 15px;}
        .chat-message {margin-bottom: 15px; padding: 10px; border-radius: 8px;}
        .user-message {background-color: #d1ecf1; border-left: 4px solid #0dcaf0;}
        .assistant-message {background-color: #d4edda; border-left: 4px solid #28a745;}
        .message-header {font-weight: bold; margin-bottom: 5px;}
        .message-text {white-space: pre-wrap;} /* Для сохранения перевода строк и форматирования */
        .message-time {font-size: 0.8rem; color: #6c757d; margin-top: 5px;}
        .no-chat-selected {display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d; font-style: italic;}
    </style>
</head>
<body>
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- Список чатов -->
        <div class="col-3 sidebar p-2">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Ваши чаты</h5>
                 <!-- Кнопка "На главную" в сайдбаре -->
                <a href="{% url 'home' %}" class="btn btn-sm btn-outline-secondary">На главную</a>
            </div>
            <ul class="list-group">
                {% for chat in chats %}
                <li class="list-group-item {% if selected_chat and chat.c_id == selected_chat.c_id %}active{% endif %}">
                    <a href="?chat_id={{ chat.c_id }}" class="text-decoration-none {% if selected_chat and chat.c_id == selected_chat.c_id %}text-white{% else %}text-dark{% endif %}">
                        {{ chat.c_title|default:"Чат" }} <br>
                        <small class="text-muted">{{ chat.c_created|date:"d.m.Y H:i" }}</small>
                    </a>
                </li>
                {% empty %}
                <li class="list-group-item">Нет завершённых чатов</li>
                {% endfor %}
            </ul>
             <!-- Дополнительная кнопка "На главную" внизу сайдбара для мобильных -->
             <div class="d-block d-md-none mt-3">
                 <a href="{% url 'home' %}" class="btn btn-secondary w-100">На главную</a>
             </div>
        </div>

        <!-- Сообщения выбранного чата -->
        <div class="col-9 chat-window p-0">
            {% if selected_chat %}
                <div class="border-bottom p-3">
                    <h5 class="mb-1">Чат №{{ selected_chat.c_id }}{% if selected_chat.c_title %} - {{ selected_chat.c_title }}{% endif %}</h5>
                    <small class="text-muted">Начат: {{ selected_chat.c_created|date:"d.m.Y H:i" }}</small>
                </div>
                <div class="chat-messages">
                    {% for msg in messages %}
                    <div class="chat-message {% if msg.role == 'user' %}user-message{% else %}assistant-message{% endif %}">
                        <div class="message-header">
                            {% if msg.role == "user" %}Вы{% else %}Психолог{% endif %}:
                        </div>
                        <div class="message-text">{{ msg.text|linebreaksbr }}</div>
                        <div class="message-time">{{ msg.created|date:"H:i d.m" }}</div>
                    </div>
                    {% empty %}
                    <p class="text-muted">Сообщений нет.</p>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-chat-selected">
                    <p class="mb-0">Выберите чат слева для просмотра истории.</p>
                </div>
            {% endif %}

            <!-- Кнопки навигации внизу (видны всегда) -->
            <div class="border-top p-3 bg-light">
                <div class="d-flex justify-content-between">
                    <a href="{% url 'chat_room' %}" class="btn btn-primary">Перейти в Чат</a>
                    <!-- Кнопка "На главную" внизу основной области -->
                    <a href="{% url 'home' %}" class="btn btn-secondary d-none d-md-inline-block">На главную</a>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>