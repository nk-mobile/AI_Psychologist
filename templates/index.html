<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Онлайн-чат с ИИ-психологом</title>
    <!-- Исправлены лишние пробелы в URL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="container py-5">

{% if messages %}
<div class="container mt-3">
    {% for message in messages %}
        <!-- Улучшено отображение сообщений с кнопкой закрытия -->
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
</div>
{% endif %}

{% if user.is_authenticated %}
    <h1>Добро пожаловать, {{ user.username }}!</h1>

    <!-- --- УЛУЧШЕНО: Информация о балансе/тарифе --- -->
    {% if active_tariff %}
        <div class="alert alert-info">
            <strong>Ваш тариф:</strong> {{ active_tariff.t_name }}
            {% if active_tariff.t_type == "mon" %}
                <!-- Для месячной подписки показываем дату окончания, рассчитанную во views.py -->
                {% load tz %}
                {% localtime on %}
                    (Действует до: {{ tariff_expiry_date|date:"d.m.Y" }})
                {% endlocaltime %}
            {% else %}
                <!-- Для других тарифов показываем оставшееся количество -->
                (Осталось: {{ active_tariff.remaining_quantity }} единиц)
            {% endif %}
        </div>
    {% else %}
        <div class="alert alert-warning">
            У вас нет активного тарифа.
        </div>
    {% endif %}
    <!-- --- КОНЕЦ УЛУЧШЕНИЯ --- -->

    <nav class="mb-3 d-flex flex-wrap gap-2">
        <!-- --- ИЗМЕНЕНО: Логика кнопки "Перейти в Чат" --- -->
        {% if has_sufficient_funds %}
            <!-- Если средства есть (или тариф mon действует), обычная ссылка на чат -->
            <a class="btn btn-primary" href="{% url 'chat_room' %}">Перейти в Чат</a>
        {% else %}
            <!-- Если средств нет, кнопка заблокирована с пояснением -->
            <button class="btn btn-primary" disabled data-bs-toggle="tooltip" data-bs-placement="top" title="Недостаточно средств, истёк срок подписки или нет активного тарифа. Пополните баланс.">
                Перейти в Чат
            </button>
            <!-- Добавляем ссылку для пополнения баланса -->
            <a class="btn btn-outline-success" href="{% url 'tariff_list' %}">Пополнить баланс</a>
        {% endif %}
        <!-- --- КОНЕЦ ИЗМЕНЕНИЯ --- -->

        <a class="btn btn-primary" href="{% url 'chat_history' %}">История чатов</a>
        <a class="btn btn-primary" href="/analysis/upload/">Эмоции</a>
        <a class="btn btn-secondary" href="/analysis/history/">История Эмоции</a>
        <a class="btn btn-secondary" href="/billing/balance/">Личный кабинет</a>
        <form method="post" action="/users/logout/" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Выйти</button>
        </form>
    </nav>
{% else %}
    <h1>Онлайн-чат с ИИ-психологом</h1>

    <!-- Добавлено: Краткое описание сайта для неавторизованных пользователей -->
    <div class="mt-4 mb-5">
        <p class="lead">
            Добро пожаловать на наш сервис поддержки психологического здоровья!
        </p>
        <p>
            Наш ИИ-психолог готов выслушать вас, помочь разобраться в чувствах и мыслях,
            а также предложить конструктивные пути решения проблем в кругу полной конфиденциальности.
        </p>
        <p class="mb-1">
            <strong>Как это работает:</strong>
        </p>
        <ul>
            <li>Просто начните диалог — первая сессия полностью <strong>бесплатна</strong>.</li>
            <li>Для продолжения общения после бесплатной сессии доступны различные тарифные планы.</li>
        </ul>
    </div>
    <!-- Конец: Краткое описание сайта -->

    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">Войти</button>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Зарегистрироваться</button>
{% endif %}

<!-- ✅ Модальное окно ЛОГИН -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">Вход</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/users/login/">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="loginEmail" class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" id="loginEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Пароль</label>
                        <input type="password" name="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Войти</button>
                </form>
                <div class="text-center mt-3">
                    <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#resetModal" data-bs-dismiss="modal">
                        Забыли пароль?
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Модальное окно РЕГИСТРАЦИЯ -->
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="registerModalLabel">Регистрация</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/users/register/" id="registerForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerUsername" class="form-label">Имя</label>
                        <input type="text" name="username" class="form-control" id="registerUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword1" class="form-label">Пароль</label>
                        <input type="password" name="password1" class="form-control" id="registerPassword1" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword2" class="form-label">Повторите пароль</label>
                        <input type="password" name="password2" class="form-control" id="registerPassword2" required>
                    </div>

                    <!-- Добавлено: Согласие на обработку персональных данных -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="privacyPolicyCheck" required>
                        <label class="form-check-label" for="privacyPolicyCheck">
                            Я согласен(а) с <a href="#" data-bs-toggle="modal" data-bs-target="#privacyPolicyModal" data-bs-dismiss="modal">политикой обработки персональных данных</a>
                        </label>
                    </div>
                    <!-- Конец: Согласие на обработку персональных данных -->

                    <!-- Кнопка регистрации изначально неактивна -->
                    <button type="submit" class="btn btn-success w-100" id="registerSubmitBtn" disabled>Зарегистрироваться</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Модальное окно ВОССТАНОВЛЕНИЕ ПАРОЛЯ -->
<div class="modal fade" id="resetModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetModalLabel">Восстановление пароля</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/users/password-reset/">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="resetEmail" class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" id="resetEmail" required>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">Отправить ссылку для восстановления</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Модальное окно ПОЛИТИКА КОНФИДЕНЦИАЛЬНОСТИ -->
<div class="modal fade" id="privacyPolicyModal" tabindex="-1" aria-labelledby="privacyPolicyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg"> <!-- Добавлен класс modal-lg для большего размера -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="privacyPolicyModalLabel">Политика в отношении обработки персональных данных</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>1. Общие положения</h6>
                <p>
                    Настоящая политика обработки персональных данных составлена в соответствии с требованиями
                    Федерального закона от 27.07.2006. №152-ФЗ «О персональных данных» и определяет порядок
                    обработки персональных данных и меры по обеспечению безопасности персональных данных,
                    предпринимаемые ИП Иванов Иван Иванович (далее – Оператор).
                </p>

                <h6>2. Основные понятия, используемые в Политике</h6>
                <ul>
                    <li><strong>Автоматизированная обработка персональных данных</strong> – обработка персональных данных с помощью средств вычислительной техники;</li>
                    <li><strong>Блокирование персональных данных</strong> – временное прекращение обработки персональных данных (за исключением случаев, если обработка необходима для уточнения персональных данных);</li>
                    <li><strong>Веб-сайт</strong> – совокупность графических и информационных материалов, а также программ для ЭВМ и баз данных, обеспечивающих их доступность в сети интернет по сетевому адресу https://вашсайт.ru;</li>
                    <li><strong>Информационная система персональных данных</strong> — совокупность содержащихся в базах данных персональных данных, и обеспечивающих их обработку информационных технологий и технических средств;</li>
                    <li><strong>Обезличивание персональных данных</strong> — действия, в результате которых невозможно определить без использования дополнительной информации принадлежность персональных данных конкретному Пользователю или иному субъекту персональных данных;</li>
                    <li><strong>Обработка персональных данных</strong> – любое действие (операция) или совокупность действий (операций), совершаемых с использованием средств автоматизации или без использования таких средств с персональными данными, включая сбор, запись, систематизацию, накопление, хранение, уточнение (обновление, изменение), извлечение, использование, передачу (распространение, предоставление, доступ), обезличивание, блокирование, удаление, уничтожение персональных данных;</li>
                    <li><strong>Оператор</strong> – государственный орган, муниципальный орган, юридическое или физическое лицо, самостоятельно или совместно с другими лицами организующие и (или) осуществляющие обработку персональных данных, а также определяющие цели обработки персональных данных, состав персональных данных, подлежащих обработке, действия (операции), совершаемые с персональными данными;</li>
                    <li><strong>Персональные данные</strong> – любая информация, относящаяся прямо или косвенно к определенному или определяемому Пользователю веб-сайта https://вашсайт.ru;</li>
                    <li><strong>Пользователь</strong> – любой посетитель веб-сайта https://вашсайт.ru;</li>
                    <li><strong>Предоставление персональных данных</strong> – действия, направленные на раскрытие персональных данных определенному лицу или определенному кругу лиц;</li>
                    <li><strong>Распространение персональных данных</strong> – любые действия, направленные на раскрытие персональных данных неопределенному кругу лиц (передача персональных данных) или на ознакомление с персональными данными неограниченного круга лиц, в том числе обнародование персональных данных в средствах массовой информации, размещение в информационно-телекоммуникационных сетях или предоставление доступа к персональным данным каким-либо иным способом;</li>
                    <li><strong>Трансграничная передача персональных данных</strong> – передача персональных данных на территорию иностранного государства органу власти иностранного государства, иностранному физическому или иностранному юридическому лицу;</li>
                    <li><strong>Уничтожение персональных данных</strong> – любые действия, в результате которых персональные данные уничтожаются безвозвратно с невозможностью дальнейшего восстановления содержания персональных данных в информационной системе персональных данных и (или) результате которых уничтожаются материальные носители персональных данных.</li>
                </ul>

                <h6>3. Оператор может обрабатывать следующие персональные данные Пользователя</h6>
                <ul>
                    <li>Фамилия, имя, отчество;</li>
                    <li>Электронный адрес;</li>
                    <li>Номера телефонов;</li>
                    <li>Год, месяц, дата и место рождения;</li>
                    <li>Фотографии;</li>
                    <li>Также на сайте происходит сбор и обработка обезличенных информационных данных о посетителях (в т.ч. файлов «cookie») с помощью сервисов интернет-статистики (Яндекс Метрика и Гугл Аналитика и других).</li>
                    <li>Вышеперечисленные данные далее по тексту Политики объединены общим понятием Персональные данные.</li>
                </ul>

                <h6>4. Цели обработки персональных данных</h6>
                <ul>
                    <li>Цель обработки персональных данных Пользователя — информирование Пользователя посредством отправки электронных писем; предоставление доступа Пользователю к сервисам, информации и/или материалам, содержащимся на веб-сайте.</li>
                    <li>Также Оператор имеет право направлять Пользователю уведомления о новых продуктах и услугах, специальных предложениях и различных событиях. Пользователь всегда может отказаться от получения информационных сообщений, направив Оператору письмо на адрес электронной почты rpa_igiis@mail.ru с пометкой «Отказ от уведомлений о новых продуктах и услугах и специальных предложениях».</li>
                    <li>Обезличенные данные Пользователей, собираемые с помощью сервисов интернет-статистики, служат для сбора информации о действиях Пользователей на сайте, улучшения качества сайта и его содержания.</li>
                </ul>

                <h6>5. Правовые основания обработки персональных данных</h6>
                <ul>
                    <li>Оператор обрабатывает персональные данные Пользователя только в случае их заполнения и/или отправки Пользователем самостоятельно через специальные формы, расположенные на сайте https://вашсайт.ru. Заполняя соответствующие формы и/или отправляя свои персональные данные Оператору, Пользователь выражает свое согласие с данной Политикой.</li>
                    <li>Оператор обрабатывает обезличенные данные о Пользователе в случае, если это разрешено в настройках браузера Пользователя (включено сохранение файлов «cookie» и использование технологии JavaScript).</li>
                </ul>

                <h6>6. Порядок сбора, хранения, передачи и других видов обработки персональных данных</h6>
                <p>
                    Безопасность персональных данных, которые обрабатываются Оператором, обеспечивается путем реализации правовых,
                    организационных и технических мер, необходимых для выполнения в полном объеме требований действующего
                    законодательства в области защиты персональных данных.
                </p>
                <ul>
                    <li>Оператор обеспечивает сохранность персональных данных и принимает все возможные меры, исключающие доступ к персональным данным неуполномоченных лиц.</li>
                    <li>Персональные данные Пользователя никогда, ни при каких условиях не будут переданы третьим лицам, за исключением случаев, связанных с исполнением действующего законодательства.</li>
                    <li>В случае выявления неточностей в персональных данных, Пользователь может актуализировать их самостоятельно, путем направления Оператору уведомление на адрес электронной почты Оператора rpa_igiis@mail.ru с пометкой «Актуализация персональных данных».</li>
                    <li>Срок обработки персональных данных является неограниченным. Пользователь может в любой момент отозвать свое согласие на обработку персональных данных, направив Оператору уведомление посредством электронной почты на электронный адрес Оператора rpa_igiis@mail.ru с пометкой «Отзыв согласия на обработку персональных данных».</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#registerModal">Назад к регистрации</button>
            </div>
        </div>
    </div>
</div>

<!-- Инициализация тултипов Bootstrap и логики согласия -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация тултипов
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            // Проверка наличия bootstrap перед созданием Tooltip
            if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            } else {
                console.warn('Bootstrap Tooltip is not available for element:', tooltipTriggerEl);
                return null;
            }
        });

        // Логика для согласия на обработку персональных данных
        const privacyCheckbox = document.getElementById('privacyPolicyCheck');
        const registerSubmitBtn = document.getElementById('registerSubmitBtn');
        const registerForm = document.getElementById('registerForm');

        if (privacyCheckbox && registerSubmitBtn) {
            // Функция для обновления состояния кнопки
            function updateSubmitButtonState() {
                registerSubmitBtn.disabled = !privacyCheckbox.checked;
            }

            // Устанавливаем начальное состояние кнопки
            updateSubmitButtonState();

            // Добавляем обработчик события на чекбокс
            privacyCheckbox.addEventListener('change', updateSubmitButtonState);

            // Дополнительно: предотвращаем отправку формы, если чекбокс не отмечен
            // (на случай, если кто-то попытается обойти через JS)
            if (registerForm) {
                registerForm.addEventListener('submit', function(e) {
                    if (!privacyCheckbox.checked) {
                        e.preventDefault();
                        alert('Пожалуйста, подтвердите согласие с политикой обработки персональных данных.');
                        return false;
                    }
                });
            }
        }
    });
</script>

</body>
</html>